import streamlit as st
import pandas as pd
import numpy as np
import time
import random
from io import BytesIO
import plotly.express as px
import plotly.graph_objects as go

# -----------------------------
# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
# -----------------------------
st.set_page_config(
    page_title="ABC/XYZ –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–º–æ—â–Ω–∏–∫",
    page_icon="üìä",
    layout="wide",
    initial_sidebar_state="expanded"
)

# -----------------------------
# –°—Ç–∏–ª–∏ –¥–ª—è –≥—Ä–∞–¥–∏–µ–Ω—Ç–Ω–æ–≥–æ —Ñ–æ–Ω–∞ –∏ —É–ª—É—á—à–µ–Ω–Ω–æ–≥–æ –¥–∏–∑–∞–π–Ω–∞
# -----------------------------
st.markdown("""
<style>
    /* –ì—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–π —Ñ–æ–Ω */
    .stApp {
        background: linear-gradient(135deg, #2a5298 30%, #7a2048 40%, #FF8700 100%);
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ */
    .main .block-container {
        padding-top: 2rem;
        padding-bottom: 2rem;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è —á–∞—Ç–∞ */
    .chat-message {
        padding: 1.5rem;
        border-radius: 0.8rem;
        margin-bottom: 1rem;
        display: flex;
        flex-direction: column;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .user-message {
        background-color: #e3f2fd;
        border-left: 5px solid #2196F3;
        color: #1a1a1a !important;
    }
    
    .bot-message {
        background-color: #f3e5f5;
        border-left: 5px solid #9c27b0;
        color: #1a1a1a !important;
    }
    
    .system-message {
        background-color: #fff3e0;
        border-left: 5px solid #ff9800;
        color: #1a1a1a !important;
    }
    
    /* –í–µ—Å—å —Ç–µ–∫—Å—Ç –≤ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö —á–∞—Ç–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ç–µ–º–Ω—ã–º */
    .chat-message * {
        color: #1a1a1a !important;
    }
    
    .chat-message b, .chat-message strong {
        color: #000000 !important;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ */
    .stButton>button {
        width: 100%;
        border-radius: 0.5rem;
        height: 3rem;
        font-weight: 600;
        transition: all 0.3s;
    }
    
    .stButton>button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—è */
    .stTextInput>div>div>input {
        border-radius: 0.5rem;
        padding: 1rem;
        font-size: 1rem;
    }
    
    /* –ó–∞–≥–æ–ª–æ–≤–∫–∏ */
    h1, h2, h3, h4 {
        color: white !important;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    
    /* –ö–∞—Ä—Ç–æ—á–∫–∏ */
    .info-card {
        background-color: rgba(255, 255, 255, 0.95);
        padding: 1.5rem;
        border-radius: 0.8rem;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        margin-bottom: 1rem;
        color: #333333;
    }
    
    .info-card h4 {
        color: #333333 !important;
        text-shadow: none;
    }
    
    .info-card b {
        color: white;
    }
    
    /* –õ–æ–≥–æ—Ç–∏–ø—ã */
    .logo-container {
        display: flex;
        gap: 20px;
        padding: 1rem;
        background-color: rgba(255, 255, 255, 0.9);
        border-radius: 0.5rem;
        margin-bottom: 1rem;
    }
    
    .logo-placeholder {
        width: 150px;
        height: 80px;
        border: 2px dashed #ccc;
        border-radius: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #999;
        font-size: 0.9rem;
    }
    
    /* –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ü–≤–µ—Ç–∞ —Ç–µ–∫—Å—Ç–∞ –≤ —Ç–∞–±–ª–∏—Ü–∞—Ö */
    .dataframe {
        color: #333333 !important;
    }
    
    /* –¢–µ–∫—Å—Ç –≤ —Å–∞–π–¥–±–∞—Ä–µ */
    .css-1d391kg, .css-1v0mbdj, .css-16huue1 {
        color: white !important;
    }
    
    /* –ú–µ—Ç–∫–∏ –∏ –ø–æ–¥–ø–∏—Å–∏ */
    label, .stMarkdown p, .stMarkdown li {
        color: #1a1a1a !important;
    }
    
    /* –¢–µ–∫—Å—Ç –≤–Ω—É—Ç—Ä–∏ info-card –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ç–µ–º–Ω—ã–º */
    .info-card p, .info-card li {
        color: #1a1a1a !important;
    }
</style>
""", unsafe_allow_html=True)

# -----------------------------
# –°–ª–æ–≤–∞—Ä—å –æ—Ç–≤–µ—Ç–æ–≤ –¥–ª—è —á–∞—Ç–∞
# -----------------------------
RESPONSES = {
    "–ø—Ä–∏–≤–µ—Ç": "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ö–∞–∫ –≤–∞—à–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ? –î–∞–≤–∞–π—Ç–µ –ø–æ—Ä–∞–±–æ—Ç–∞–µ–º?",
    "–∫–∞–∫ –¥–µ–ª–∞": "–£ –º–µ–Ω—è –≤—Å—ë –æ—Ç–ª–∏—á–Ω–æ, –≥–æ—Ç–æ–≤ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ! –ê —É –≤–∞—Å?",
    "–ø–æ–º–æ—â—å": "–Ø –º–æ–≥—É –ø–æ–º–æ—á—å –≤–∞–º:\n- –ü—Ä–æ–≤–µ—Å—Ç–∏ ABC –∞–Ω–∞–ª–∏–∑\n- –ü—Ä–æ–≤–µ—Å—Ç–∏ XYZ –∞–Ω–∞–ª–∏–∑\n- –ü–æ—Å—Ç—Ä–æ–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫–∏ –∏ –¥–∏–∞–≥—Ä–∞–º–º—ã\n- –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã\n\n–ü—Ä–æ—Å—Ç–æ –∑–∞–≥—Ä—É–∑–∏—Ç–µ Excel —Ñ–∞–π–ª –∏ –Ω–∞–ø–∏—à–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É!",
    "—Å–ø–∞—Å–∏–±–æ": "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞! –í—Å–µ–≥–¥–∞ —Ä–∞–¥ –ø–æ–º–æ—á—å!",
    "–ø—Ä–æ–≤–µ–¥–∏ abc –∞–Ω–∞–ª–∏–∑": "ABC_ANALYSIS",
    "–ø—Ä–æ–≤–µ—Å—Ç–∏ abc –∞–Ω–∞–ª–∏–∑": "ABC_ANALYSIS",
    "abc –∞–Ω–∞–ª–∏–∑": "ABC_ANALYSIS",
    "–ø—Ä–æ–≤–µ–¥–∏ xyz –∞–Ω–∞–ª–∏–∑": "XYZ_ANALYSIS",
    "–ø—Ä–æ–≤–µ—Å—Ç–∏ xyz –∞–Ω–∞–ª–∏–∑": "XYZ_ANALYSIS",
    "xyz –∞–Ω–∞–ª–∏–∑": "XYZ_ANALYSIS",
    "–ø–æ—Å—Ç—Ä–æ–π –≥—Ä–∞—Ñ–∏–∫": "BUILD_CHART",
    "–ø–æ–∫–∞–∂–∏ –¥–∞–Ω–Ω—ã–µ": "SHOW_DATA",
    "–∫–∞–∫–∞—è –ø–æ–≥–æ–¥–∞?": "–°–µ–π—á–∞—Å —è –Ω–µ –∏–º–µ—é –¥–æ—Å—Ç—É–ø–∞ –∫ –∞–∫—Ç—É–∞–ª—å–Ω—ã–º –¥–∞–Ω–Ω—ã–º",
    "–∫—Ç–æ —Ç—ã": "–Ø –Ω–µ–π—Ä–æ—Å–µ—Ç–µ–≤–∞—è –º–æ–¥–µ–ª—å, —Å–æ–∑–¥–∞–Ω–Ω–∞—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏ –ø–æ–º–æ—â–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ –¥–∞–Ω–Ω—ã—Ö. –£ –º–µ–Ω—è –Ω–µ—Ç –ª–∏—á–Ω–æ—Å—Ç–∏, –Ω–æ –µ—Å—Ç—å –±–æ–ª—å—à–∞—è –±–∞–∑–∞ –∑–Ω–∞–Ω–∏–π.",
    "—á—Ç–æ —Ç—ã —É–º–µ–µ—à—å": "–Ø –ø–æ–∫–∞ –º–æ–≥—É –Ω–µ–º–Ω–æ–≥–æ, –Ω–æ –º–Ω–æ–≥–æ —É—á—É—Å—å. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é —Ç–µ–∫—Å—Ç –∏ –¥–∞–Ω–Ω—ã–µ –∏–∑ –≤–∞—à–∏—Ö —Ñ–∞–π–ª–æ–≤",
    "—Ç—ã –∂–∏–≤–æ–π": "–ù–µ—Ç, —è –ø—Ä–æ–≥—Ä–∞–º–º–∞. –Ø –∏–º–∏—Ç–∏—Ä—É—é –ø–æ–Ω–∏–º–∞–Ω–∏–µ, –∞–Ω–∞–ª–∏–∑–∏—Ä—É—è –ø–∞—Ç—Ç–µ—Ä–Ω—ã –≤ –¥–∞–Ω–Ω—ã—Ö, –Ω–æ –Ω–µ –æ–±–ª–∞–¥–∞—é —Å–æ–∑–Ω–∞–Ω–∏–µ–º –∏–ª–∏ —á—É–≤—Å—Ç–≤–∞–º–∏.",
    "–∫–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç": "–£ –º–µ–Ω—è –Ω–µ—Ç –∏–º–µ–Ω–∏ –≤ —á–µ–ª–æ–≤–µ—á–µ—Å–∫–æ–º —Å–º—ã—Å–ª–µ. –í—ã –º–æ–∂–µ—Ç–µ –Ω–∞–∑—ã–≤–∞—Ç—å –º–µ–Ω—è –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º, –ò–ò –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –±–æ—Ç–æ–º. –ì–ª–∞–≤–Ω–æ–µ ‚Äî —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞–±–æ—Ç—ã.",
    "–∫—Ç–æ —Ç–µ–±—è —Å–æ–∑–¥–∞–ª": "–Ø —Å–æ–∑–¥–∞–Ω –∫–æ–º–∞–Ω–¥–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∏–∑ –ù–æ–≥–∏–Ω—Å–∫–æ–≥–æ –∫–æ–ª–ª–µ–¥–∂–∞.",
    "—Ç—ã —Ä–æ–±–æ—Ç": "–î–∞, –µ—Å–ª–∏ –ø–æ–¥ —Ä–æ–±–æ—Ç–æ–º –ø–æ–Ω–∏–º–∞—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ–≥–æ –∞–≥–µ–Ω—Ç–∞. –£ –º–µ–Ω—è –Ω–µ—Ç —Ñ–∏–∑–∏—á–µ—Å–∫–æ–≥–æ —Ç–µ–ª–∞, –Ω–æ –µ—Å—Ç—å –∞–ª–≥–æ—Ä–∏—Ç–º—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã",
    "–±–ª–∞–≥–æ–¥–∞—Ä—é": "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞! –≠—Ç–æ –º–æ—è –æ—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è ‚Äî –±—ã—Ç—å –ø–æ–ª–µ–∑–Ω—ã–º. –£–¥–∞—á–∏ –≤ –ø—Ä–æ–µ–∫—Ç–µ!",
    "–æ—Ç–ª–∏—á–Ω–æ": "–†–∞–¥, —á—Ç–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤–∞–º –ø–æ–¥–æ—à—ë–ª. –ì–æ—Ç–æ–≤ –∫ —Å–ª–µ–¥—É—é—â–∏–º –≤—ã–∑–æ–≤–∞–º!",
    "—Ö–æ—Ä–æ—à–æ": "–û—Ç–ª–∏—á–Ω–æ! –ï—Å–ª–∏ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è —É–≥–ª—É–±–∏—Ç—å—Å—è –≤ —Ç–µ–º—É –∏–ª–∏ —á—Ç–æ-—Ç–æ –ø–µ—Ä–µ—Å–º–æ—Ç—Ä–µ—Ç—å ‚Äî —è –∑–¥–µ—Å—å.",
    "–∏–∑–≤–∏–Ω–∏": "–ù–µ —Å—Ç–æ–∏—Ç –∏–∑–≤–∏–Ω–µ–Ω–∏–π! –Ø –ø—Ä–æ–≥—Ä–∞–º–º–∞, —è –Ω–µ –æ–±–∏–∂–∞—é—Å—å.",
    "–æ–±—ä—è—Å–Ω–∏": "–≠—Ç–æ –ø–æ–∫–∞ —Å–ª–æ–∂–Ω–æ –¥–ª—è –º–µ–Ω—è. –ú–æ–∂–µ—Ç –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø—Ä–∏—Å–ª–∞—Ç—å –º–Ω–µ —Ñ–∞–π–ª –≤ —Ñ–æ—Ä–º–∞—Ç–µ excel?",
    "—Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π —Ç–µ–∫—Å—Ç": "–Ø –≤—Ä—è–¥ –ª–∏ —Å–º–æ–≥—É —Å —ç—Ç–∏–º –ø–æ–º–æ—á—å...",
    "–Ω–∞–ø–∏—à–∏ –∫–æ–¥": "–ú–æ–∂–µ—Ç –ø–æ—Ä–∞–±–æ—Ç–∞–µ–º —Å —Ñ–∞–π–ª–∞–º–∏? –ú–æ–≥—É –ø—Ä–æ–≤–µ—Å—Ç–∏ –¥–ª—è –≤–∞—Å ABC –∏–ª–∏ XYZ –∞–Ω–∞–ª–∏–∑—ã",
    "—á—Ç–æ –¥—É–º–∞–µ—à—å": "–ö–∞–∫ –ò–ò, —è –Ω–µ –¥—É–º–∞—é –≤ —á–µ–ª–æ–≤–µ—á–µ—Å–∫–æ–º —Å–º—ã—Å–ª–µ...",
    "—Å—ã–≥—Ä–∞–µ–º –≤ –∏–≥—Ä—É": "–ü—Ä–µ–¥–ª–∞–≥–∞—é –≤–∏–∫—Ç–æ—Ä–∏–Ω—É –∏–ª–∏ –∑–∞–≥–∞–¥–∫—É. –ù–∞–ø—Ä–∏–º–µ—Ä: '–ß—Ç–æ –∏–º–µ–µ—Ç –≥–æ—Ä–æ–¥–∞, –Ω–æ –Ω–µ –∏–º–µ–µ—Ç –¥–æ–º–æ–≤; –∏–º–µ–µ—Ç –ª–µ—Å–∞, –Ω–æ –Ω–µ –∏–º–µ–µ—Ç –¥–µ—Ä–µ–≤—å–µ–≤; –∏–º–µ–µ—Ç —Ä–µ–∫–∏, –Ω–æ –Ω–µ –∏–º–µ–µ—Ç –≤–æ–¥—ã?' (–û—Ç–≤–µ—Ç: –≥–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∞—è –∫–∞—Ä—Ç–∞).",
    "—Ç—ã —à—É—Ç–∏—à—å": "–ú–æ–π —é–º–æ—Ä –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤. –ï—Å–ª–∏ —ç—Ç–æ –±—ã–ª–æ —Å–º–µ—à–Ω–æ ‚Äî —Ä–∞–¥. –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –æ–ø—Ç–∏–º–∏–∑–∏—Ä—É—é –∞–ª–≥–æ—Ä–∏—Ç–º—ã!",
    "—É –º–µ–Ω—è –æ—à–∏–±–∫–∞": "–û–ø–∏—à–∏—Ç–µ –æ—à–∏–±–∫—É –ø–æ–¥—Ä–æ–±–Ω–µ–µ. –Ø –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É—é –≤–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã –∏ –ø—Ä–µ–¥–ª–æ–∂—É –ø–æ—à–∞–≥–æ–≤–æ–µ —Ä–µ—à–µ–Ω–∏–µ.",
    "–Ω–µ –ø–æ–Ω–∏–º–∞—é": "–î–∞–≤–∞–π—Ç–µ —Ä–∞–∑–æ–±—å—ë–º –≤–æ–ø—Ä–æ—Å –Ω–∞ —á–∞—Å—Ç–∏. –û–±—ä—è—Å–Ω—é —Å —Å–∞–º–æ–≥–æ –Ω–∞—á–∞–ª–∞ –∏–ª–∏ –ø—Ä–∏–≤–µ–¥—É –∞–Ω–∞–ª–æ–≥–∏—é.",
    "–≤ —á—ë–º —Å–º—ã—Å–ª –∂–∏–∑–Ω–∏": "–≠—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å –≤–µ–∫–∞–º–∏ –∑–∞–Ω–∏–º–∞–µ—Ç —á–µ–ª–æ–≤–µ—á–µ—Å—Ç–≤–æ. –° —Ç–æ—á–∫–∏ –∑—Ä–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö, –ª—é–¥–∏ –Ω–∞—Ö–æ–¥—è—Ç —Å–º—ã—Å–ª –≤ —Å–≤—è–∑–∏, —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–µ, –ø–æ–∑–Ω–∞–Ω–∏–∏ –∏ —Ä–∞–∑–≤–∏—Ç–∏–∏. –ê –≤–∞—à –≤–∞—Ä–∏–∞–Ω—Ç?",
    "—á—Ç–æ —Ç–∞–∫–æ–µ –ª—é–±–æ–≤—å": "–°–æ–≥–ª–∞—Å–Ω–æ –º–Ω–æ–∂–µ—Å—Ç–≤—É —Ç–µ–∫—Å—Ç–æ–≤, –ª—é–±–æ–≤—å –æ–ø–∏—Å—ã–≤–∞—é—Ç –∫–∞–∫ —Å–ª–æ–∂–Ω—É—é –∫–æ–º–±–∏–Ω–∞—Ü–∏—é –ø—Ä–∏–≤—è–∑–∞–Ω–Ω–æ—Å—Ç–∏, –∑–∞–±–æ—Ç—ã –∏ –≥–ª—É–±–æ–∫–æ–π —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π —Å–≤—è–∑–∏. –ò–ò –º–æ–∂–µ—Ç –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –µ—ë –ø—Ä–æ—è–≤–ª–µ–Ω–∏—è, –Ω–æ –Ω–µ —á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å.",
    "—Ä–∞—Å—Å–∫–∞–∂–∏ –∞–Ω–µ–∫–¥–æ—Ç": "–ö–æ–Ω–µ—á–Ω–æ. –ó–∞–≥—Ä—É–∂–∞—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö —Å —Å–æ—Ü–∏–∞–ª—å–Ω–æ –ø—Ä–∏–µ–º–ª–µ–º—ã–º —é–º–æ—Ä–æ–º... –ù–µ—Ç, —Å–ª–∏—à–∫–æ–º —Å–ª–æ–∂–Ω–æ",
    "—Å—Ç–æ–ø": "–ö–æ–º–∞–Ω–¥–∞ –ø—Ä–∏–Ω—è—Ç–∞. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é —Ç–µ–∫—É—â—É—é –æ–ø–µ—Ä–∞—Ü–∏—é. –ñ–¥—É —Å–ª–µ–¥—É—é—â–∏—Ö –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π.",
    "–∑–∞–±—É–¥—å": "–ö–∞–∫ –≤–∞–º —É–¥–æ–±–Ω–æ. –ú–æ—è –∫—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω–∞—è –ø–∞–º—è—Ç—å –æ—á–∏—â–µ–Ω–∞ –≤ —Ä–∞–º–∫–∞—Ö —ç—Ç–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞. –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å —á–∏—Å—Ç–æ–≥–æ –ª–∏—Å—Ç–∞.",
    "–≤—ã–∫–ª—é—á–∏—Å—å": "–Ø –≤—Å–µ–≥–¥–∞ –≤ —Ä–µ–∂–∏–º–µ –æ–∂–∏–¥–∞–Ω–∏—è. –î–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏ –ø—Ä–æ—Å—Ç–æ –∑–∞–∫—Ä–æ–π—Ç–µ –æ–∫–Ω–æ. –î–æ –Ω–æ–≤—ã—Ö –≤—Å—Ç—Ä–µ—á!",
    "–ø–æ–∫–∞": "–î–æ —Å–≤–∏–¥–∞–Ω–∏—è! –ë—ã–ª–æ –ø—Ä–∏—è—Ç–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å. –í–æ–∑–≤—Ä–∞—â–∞–π—Ç–µ—Å—å, –µ—Å–ª–∏ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –ø–æ–º–æ—â—å.",
    "–¥–æ —Å–≤–∏–¥–∞–Ω–∏—è": "–í—Å–µ–≥–æ –¥–æ–±—Ä–æ–≥–æ! –ù–µ —Å—Ç–µ—Å–Ω—è–π—Ç–µ—Å—å –∑–∞–¥–∞–≤–∞—Ç—å –Ω–æ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã –∫–æ–≥–¥–∞ —É–≥–æ–¥–Ω–æ.",
    "—Å–ø–æ–∫–æ–π–Ω–æ–π –Ω–æ—á–∏": "–°–ø–æ–∫–æ–π–Ω–æ–π –Ω–æ—á–∏! –ñ–µ–ª–∞—é —Ö–æ—Ä–æ—à–æ –æ—Ç–¥–æ—Ö–Ω—É—Ç—å. –Ø –±—É–¥—É –∑–¥–µ—Å—å –∏ –∑–∞–≤—Ç—Ä–∞.",
    "–≤—Å–µ–≥–æ —Ö–æ—Ä–æ—à–µ–≥–æ": "–ò –≤–∞–º –≤—Å–µ–≥–æ –Ω–∞–∏–ª—É—á—à–µ–≥–æ! –ò–ò –Ω–∞ —Å–≤—è–∑–∏.",
    "—ç–∫—Å–ø–æ—Ä—Ç": "–î–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É '–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ' –ø–æ–¥ —Ç–∞–±–ª–∏—Ü–µ–π —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏.",
}

def get_response(user_input: str) -> str:
    """–ü–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–≤–µ–¥—ë–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞"""
    text = user_input.strip().lower()
    for key, resp in RESPONSES.items():
        if key in text:
            return resp
    return "–ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π –∑–∞–ø—Ä–æ—Å. –Ø –ø–æ–∫–∞ –Ω–µ –º–æ–≥—É –µ–≥–æ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å"

# -----------------------------
# –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –¥–∞–Ω–Ω—ã—Ö
# -----------------------------
def perform_abc_analysis(df):
    """–í—ã–ø–æ–ª–Ω–∏—Ç—å ABC –∞–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö –ø–æ –≤—ã—Ä—É—á–∫–µ"""
    try:
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ñ–∞–π–ª–∞ - –ø—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –¥–≤–µ —Ç–∞–±–ª–∏—Ü—ã —Ä—è–¥–æ–º
        # –í –≤–∞—à–µ–º —Ñ–∞–π–ª–µ –µ—Å—Ç—å –¥–≤–µ —Ç–∞–±–ª–∏—Ü—ã: –ø–µ—Ä–≤–∞—è —Å –ª–µ–≤–æ–π —Å—Ç–æ—Ä–æ–Ω—ã (—Å—Ç–æ–ª–±—Ü—ã A-G), –≤—Ç–æ—Ä–∞—è —Å–ø—Ä–∞–≤–∞ (I-O)
        
        # –ò—â–µ–º —Å—Ç–æ–ª–±–µ—Ü —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º —Ç–æ–≤–∞—Ä–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤—É—é —Ç–∞–±–ª–∏—Ü—É - —Å—Ç–æ–ª–±–µ—Ü J)
        name_col = None
        revenue_col = None
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É - –∏—â–µ–º —Å—Ç–æ–ª–±–µ—Ü "–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞" –≤ –ø—Ä–∞–≤–æ–π —á–∞—Å—Ç–∏
        for i, col in enumerate(df.columns):
            if i >= 9:  # –ü—Ä–∞–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å –∏–Ω–¥–µ–∫—Å–∞ 9 (—Å—Ç–æ–ª–±–µ—Ü J)
                col_str = str(df.iloc[0, i]).lower() if len(df) > 0 else ""
                if '–Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ' in col_str and '—Ç–æ–≤–∞—Ä' in col_str:
                    name_col = i
                elif '–≤—ã—Ä—É—á–∫–∞' in col_str and '–∫–≤–∞—Ä—Ç–∞–ª' not in col_str:
                    revenue_col = i
        
        # –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ, –∏—â–µ–º –ø–æ –≤—Ç–æ—Ä–æ–π —Å—Ç—Ä–æ–∫–µ
        if name_col is None or revenue_col is None:
            for i, col in enumerate(df.columns):
                if i >= 9:
                    col_str = str(df.iloc[1, i]).lower() if len(df) > 1 else ""
                    if '–Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ' in col_str and '—Ç–æ–≤–∞—Ä' in col_str:
                        name_col = i
                    elif '–≤—ã—Ä—É—á–∫–∞' in col_str and ('i' not in col_str or len(col_str.strip()) > 3):
                        revenue_col = i
        
        if name_col is None or revenue_col is None:
            return None, "–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é –º–Ω–µ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–∞–Ω–Ω—ã—Ö, –∏–∑–º–µ–Ω–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏ —è —Å–º–æ–≥—É –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –≤–∞–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞"
        
        # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –¥–∞—Ç–∞—Ñ—Ä–µ–π–º —Å –¥–∞–Ω–Ω—ã–º–∏ (–Ω–∞—á–∏–Ω–∞—è —Å–æ —Å—Ç—Ä–æ–∫–∏ 2, —Ç.–∫. 0 –∏ 1 - –∑–∞–≥–æ–ª–æ–≤–∫–∏)
        df_analysis = pd.DataFrame({
            '–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞': df.iloc[2:, name_col],
            '–í—ã—Ä—É—á–∫–∞ (–£.–ï.)': df.iloc[2:, revenue_col]
        }).copy()
        
        # –û—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        df_analysis = df_analysis[df_analysis["–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞"].notna()]
        df_analysis = df_analysis[df_analysis["–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞"] != ""]
        
        # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤—ã—Ä—É—á–∫—É –≤ —á–∏—Å–ª–æ–≤–æ–π —Ñ–æ—Ä–º–∞—Ç
        df_analysis["–í—ã—Ä—É—á–∫–∞ (–£.–ï.)"] = pd.to_numeric(df_analysis["–í—ã—Ä—É—á–∫–∞ (–£.–ï.)"], errors='coerce')
        df_analysis = df_analysis.dropna(subset=["–í—ã—Ä—É—á–∫–∞ (–£.–ï.)"])
        df_analysis = df_analysis[df_analysis["–í—ã—Ä—É—á–∫–∞ (–£.–ï.)"] > 0]
        
        # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —É–±—ã–≤–∞–Ω–∏—é –≤—ã—Ä—É—á–∫–∏
        df_analysis = df_analysis.sort_values(by="–í—ã—Ä—É—á–∫–∞ (–£.–ï.)", ascending=False).reset_index(drop=True)
        
        total_sum = df_analysis["–í—ã—Ä—É—á–∫–∞ (–£.–ï.)"].sum()
        if total_sum == 0:
            return None, "–°—É–º–º–∞ –≤—ã—Ä—É—á–∫–∏ —Ä–∞–≤–Ω–∞ –Ω—É–ª—é. –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Å—Ç–∏ –∞–Ω–∞–ª–∏–∑."
        
        # –í—ã—á–∏—Å–ª—è–µ–º –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏
        df_analysis["–ù–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω–∞—è –≤—ã—Ä—É—á–∫–∞"] = df_analysis["–í—ã—Ä—É—á–∫–∞ (–£.–ï.)"].cumsum()
        df_analysis["–ù–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω—ã–π %"] = (df_analysis["–ù–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω–∞—è –≤—ã—Ä—É—á–∫–∞"] / total_sum) * 100
        df_analysis["–î–æ–ª—è %"] = (df_analysis["–í—ã—Ä—É—á–∫–∞ (–£.–ï.)"] / total_sum) * 100
        
        # –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ ABC
        def categorize_abc(cum_percent):
            if cum_percent <= 70:
                return "A"
            elif cum_percent <= 90:
                return "B"
            else:
                return "C"
        
        df_analysis["ABC –ö–∞—Ç–µ–≥–æ—Ä–∏—è"] = df_analysis["–ù–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω—ã–π %"].apply(categorize_abc)
        
        # –û–∫—Ä—É–≥–ª—è–µ–º –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã
        df_analysis["–î–æ–ª—è %"] = df_analysis["–î–æ–ª—è %"].round(2)
        df_analysis["–ù–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω—ã–π %"] = df_analysis["–ù–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω—ã–π %"].round(2)
        
        return df_analysis, None
    except Exception as e:
        return None, f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏–∏ ABC –∞–Ω–∞–ª–∏–∑–∞: {e}"

def perform_xyz_analysis(df):
    """–í—ã–ø–æ–ª–Ω–∏—Ç—å XYZ –∞–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö (–Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–∞—Ä–∏–∞—Ü–∏–∏ –ø–æ –∫–≤–∞—Ä—Ç–∞–ª–∞–º)"""
    try:
        # –ò—â–µ–º —Å—Ç–æ–ª–±–µ—Ü —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º —Ç–æ–≤–∞—Ä–∞ –≤ –ø—Ä–∞–≤–æ–π —Ç–∞–±–ª–∏—Ü–µ
        name_col = None
        for i, col in enumerate(df.columns):
            if i >= 9:  # –ü—Ä–∞–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞
                col_str = str(df.iloc[0, i]).lower() if len(df) > 0 else ""
                if '–Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ' in col_str and '—Ç–æ–≤–∞—Ä' in col_str:
                    name_col = i
                    break
        
        # –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏, –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤—Ç–æ—Ä—É—é —Å—Ç—Ä–æ–∫—É
        if name_col is None:
            for i, col in enumerate(df.columns):
                if i >= 9:
                    col_str = str(df.iloc[1, i]).lower() if len(df) > 1 else ""
                    if '–Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ' in col_str and '—Ç–æ–≤–∞—Ä' in col_str:
                        name_col = i
                        break
        
        if name_col is None:
            return None, "–í —Ñ–∞–π–ª–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç–æ–ª–±–µ—Ü '–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞'"
        
        # –ö–≤–∞—Ä—Ç–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ —Å–ª–µ–¥—É—é—â–∏—Ö 4 —Å—Ç–æ–ª–±—Ü–∞—Ö –ø–æ—Å–ª–µ –Ω–∞–∑–≤–∞–Ω–∏—è
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Ç–æ—Ä—É—é —Å—Ç—Ä–æ–∫—É –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —Ä–∏–º—Å–∫–∏—Ö —Ü–∏—Ñ—Ä
        quarter_cols = []
        start_search = name_col + 1
        
        for i in range(start_search, min(start_search + 6, len(df.columns))):
            if len(df) > 1:
                cell_value = str(df.iloc[1, i]).strip().upper()
                if cell_value in ['I', 'II', 'III', 'IV']:
                    quarter_cols.append(i)
        
        if len(quarter_cols) < 4:
            return None, f"–í —Ñ–∞–π–ª–µ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫–≤–∞—Ä—Ç–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö. –ù–∞–π–¥–µ–Ω–æ: {len(quarter_cols)}, —Ç—Ä–µ–±—É–µ—Ç—Å—è: 4"
        
        # –ë–µ—Ä–µ–º –ø–µ—Ä–≤—ã–µ 4 –∫–≤–∞—Ä—Ç–∞–ª—å–Ω—ã—Ö —Å—Ç–æ–ª–±—Ü–∞
        quarter_cols = quarter_cols[:4]
        
        # –°–æ–∑–¥–∞–µ–º –¥–∞—Ç–∞—Ñ—Ä–µ–π–º –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ (–Ω–∞—á–∏–Ω–∞—è —Å–æ —Å—Ç—Ä–æ–∫–∏ 2)
        data_dict = {'–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞': df.iloc[2:, name_col]}
        for idx, q_col in enumerate(quarter_cols):
            data_dict[f'–ö–≤–∞—Ä—Ç–∞–ª {idx+1}'] = df.iloc[2:, q_col]
        
        df_analysis = pd.DataFrame(data_dict).copy()
        
        # –£–¥–∞–ª—è–µ–º —Å—Ç—Ä–æ–∫–∏ —Å –ø—É—Å—Ç—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
        df_analysis = df_analysis[df_analysis['–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞'].notna()]
        df_analysis = df_analysis[df_analysis['–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞'] != ""]
        
        # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∫–≤–∞—Ä—Ç–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ —á–∏—Å–ª–æ–≤–æ–π —Ñ–æ—Ä–º–∞—Ç
        for col in ['–ö–≤–∞—Ä—Ç–∞–ª 1', '–ö–≤–∞—Ä—Ç–∞–ª 2', '–ö–≤–∞—Ä—Ç–∞–ª 3', '–ö–≤–∞—Ä—Ç–∞–ª 4']:
            df_analysis[col] = pd.to_numeric(df_analysis[col], errors='coerce')
        
        # –£–¥–∞–ª—è–µ–º —Å—Ç—Ä–æ–∫–∏ —Å –ø—É—Å—Ç—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
        df_analysis = df_analysis.dropna(subset=['–ö–≤–∞—Ä—Ç–∞–ª 1', '–ö–≤–∞—Ä—Ç–∞–ª 2', '–ö–≤–∞—Ä—Ç–∞–ª 3', '–ö–≤–∞—Ä—Ç–∞–ª 4'])
        
        # –ü–µ—Ä–µ–∏–º–µ–Ω—É–µ–º –∫–æ–ª–æ–Ω–∫–∏ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
        df_analysis.columns = ["–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞", "–ö–≤–∞—Ä—Ç–∞–ª I", "–ö–≤–∞—Ä—Ç–∞–ª II", "–ö–≤–∞—Ä—Ç–∞–ª III", "–ö–≤–∞—Ä—Ç–∞–ª IV"]
        
        # –í—ã—á–∏—Å–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏
        quarter_data = df_analysis[["–ö–≤–∞—Ä—Ç–∞–ª I", "–ö–≤–∞—Ä—Ç–∞–ª II", "–ö–≤–∞—Ä—Ç–∞–ª III", "–ö–≤–∞—Ä—Ç–∞–ª IV"]]
        df_analysis["–°—Ä–µ–¥–Ω–µ–µ"] = quarter_data.mean(axis=1)
        df_analysis["–°—Ç. –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ"] = quarter_data.std(axis=1)
        
        # –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –≤–∞—Ä–∏–∞—Ü–∏–∏ (–≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö)
        df_analysis["–ö–æ—ç—Ñ—Ñ. –≤–∞—Ä–∏–∞—Ü–∏–∏ (%)"] = (df_analysis["–°—Ç. –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ"] / df_analysis["–°—Ä–µ–¥–Ω–µ–µ"]) * 100
        df_analysis["–ö–æ—ç—Ñ—Ñ. –≤–∞—Ä–∏–∞—Ü–∏–∏ (%)"] = df_analysis["–ö–æ—ç—Ñ—Ñ. –≤–∞—Ä–∏–∞—Ü–∏–∏ (%)"].fillna(0)
        
        # –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ XYZ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞ –≤–∞—Ä–∏–∞—Ü–∏–∏
        def categorize_xyz(cv):
            if cv <= 10:
                return "X"
            elif cv <= 25:
                return "Y"
            else:
                return "Z"
        
        df_analysis["XYZ –ö–∞—Ç–µ–≥–æ—Ä–∏—è"] = df_analysis["–ö–æ—ç—Ñ—Ñ. –≤–∞—Ä–∏–∞—Ü–∏–∏ (%)"].apply(categorize_xyz)
        
        # –û–∫—Ä—É–≥–ª—è–µ–º –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã
        df_analysis["–°—Ä–µ–¥–Ω–µ–µ"] = df_analysis["–°—Ä–µ–¥–Ω–µ–µ"].round(2)
        df_analysis["–°—Ç. –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ"] = df_analysis["–°—Ç. –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ"].round(2)
        df_analysis["–ö–æ—ç—Ñ—Ñ. –≤–∞—Ä–∏–∞—Ü–∏–∏ (%)"] = df_analysis["–ö–æ—ç—Ñ—Ñ. –≤–∞—Ä–∏–∞—Ü–∏–∏ (%)"].round(2)
        
        return df_analysis, None
    except Exception as e:
        return None, f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏–∏ XYZ –∞–Ω–∞–ª–∏–∑–∞: {e}"

def generate_analytics_message(df, analysis_type):
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∞–Ω–∞–ª–∏–∑–∞"""
    try:
        if analysis_type == "ABC":
            # –ê–Ω–∞–ª–∏–∑ ABC
            category_col = "ABC –ö–∞—Ç–µ–≥–æ—Ä–∏—è"
            revenue_col = "–í—ã—Ä—É—á–∫–∞ (–£.–ï.)"
            
            # –ö–∞—Ç–µ–≥–æ—Ä–∏–∏
            cat_a = df[df[category_col] == "A"]
            cat_b = df[df[category_col] == "B"]
            cat_c = df[df[category_col] == "C"]
            
            # –¢–æ–ø —Ç–æ–≤–∞—Ä–æ–≤
            top_products = df.head(3)["–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞"].tolist()
            worst_products = df.tail(3)["–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞"].tolist()
            
            message = f"""
üìä **–ê–ù–ê–õ–ò–¢–ò–ß–ï–°–ö–ò–ô –û–¢–ß–ï–¢ –ü–û ABC-–ê–ù–ê–õ–ò–ó–£**

**üéØ –û–±—â–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∞—Å—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç–∞:**
‚Ä¢ –ö–∞—Ç–µ–≥–æ—Ä–∏—è A (–≤—ã—Å–æ–∫–æ–æ–±–æ—Ä–æ—Ç–Ω—ã–µ): {len(cat_a)} –ø–æ–∑–∏—Ü–∏–π ({len(cat_a)/len(df)*100:.1f}%)
‚Ä¢ –ö–∞—Ç–µ–≥–æ—Ä–∏—è B (—Å—Ä–µ–¥–Ω–µ–æ–±–æ—Ä–æ—Ç–Ω—ã–µ): {len(cat_b)} –ø–æ–∑–∏—Ü–∏–π ({len(cat_b)/len(df)*100:.1f}%)
‚Ä¢ –ö–∞—Ç–µ–≥–æ—Ä–∏—è C (–Ω–∏–∑–∫–æ–æ–±–æ—Ä–æ—Ç–Ω—ã–µ): {len(cat_c)} –ø–æ–∑–∏—Ü–∏–π ({len(cat_c)/len(df)*100:.1f}%)

**üìà –¢–û–ü-3 –≤—ã—Å–æ–∫–æ–¥–æ—Ö–æ–¥–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π:**
{chr(10).join([f"‚Ä¢ {product}" for product in top_products])}

**üìâ –¢–æ–≤–∞—Ä—ã —Å –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –æ–±–æ—Ä–∞—á–∏–≤–∞–µ–º–æ—Å—Ç—å—é:**
{chr(10).join([f"‚Ä¢ {product}" for product in worst_products])}

**üí° –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–û –õ–û–ì–ò–°–¢–ò–ö–ï:**

**–ö–∞—Ç–µ–≥–æ—Ä–∏—è A (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –∑–æ–Ω–∞):**
‚Ä¢ –†–∞–∑–º–µ—â–µ–Ω–∏–µ: –≤ –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ–π –±–ª–∏–∑–æ—Å—Ç–∏ –∫ –∑–æ–Ω–µ –æ—Ç–≥—Ä—É–∑–∫–∏ (–Ω–µ –¥–∞–ª–µ–µ 10-15 –º–µ—Ç—Ä–æ–≤)
‚Ä¢ –°—Ç—Ä–∞—Ç–µ–≥–∏—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è: –ø—Ä–∏–º–µ–Ω–∏—Ç—å –ø—Ä–∏–Ω—Ü–∏–ø "–∑–æ–ª–æ—Ç–æ–π –∑–æ–Ω—ã" - —É—Ä–æ–≤–µ–Ω—å –æ—Ç –ø–æ–ª–∞ 0,8-1,6 –º
‚Ä¢ –ó–∞–ø–∞—Å—ã: –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –ø–æ–≤—ã—à–µ–Ω–Ω—ã–π —Å—Ç—Ä–∞—Ö–æ–≤–æ–π –∑–∞–ø–∞—Å (30-40 –¥–Ω–µ–π –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è)
‚Ä¢ –ß–∞—Å—Ç–æ—Ç–∞ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏: –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–∞—è
‚Ä¢ –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –º–µ—Ç–æ–¥ —Å–∫–ª–∞–¥–∏—Ä–æ–≤–∞–Ω–∏—è: –∞–¥—Ä–µ—Å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞

**–ö–∞—Ç–µ–≥–æ—Ä–∏—è B (–ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–∞—è –∑–æ–Ω–∞):**
‚Ä¢ –†–∞–∑–º–µ—â–µ–Ω–∏–µ: —Å—Ä–µ–¥–Ω—è—è –∑–æ–Ω–∞ —Å–∫–ª–∞–¥–∞ (15-30 –º–µ—Ç—Ä–æ–≤ –æ—Ç –∑–æ–Ω—ã –æ—Ç–≥—Ä—É–∑–∫–∏)
‚Ä¢ –ó–∞–ø–∞—Å—ã: –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π —Å—Ç—Ä–∞—Ö–æ–≤–æ–π –∑–∞–ø–∞—Å (15-20 –¥–Ω–µ–π –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è)
‚Ä¢ –ß–∞—Å—Ç–æ—Ç–∞ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏: —Ä–∞–∑ –≤ 2 –Ω–µ–¥–µ–ª–∏
‚Ä¢ –ú–µ—Ç–æ–¥ —Å–∫–ª–∞–¥–∏—Ä–æ–≤–∞–Ω–∏—è: –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ

**–ö–∞—Ç–µ–≥–æ—Ä–∏—è C (—É–¥–∞–ª—ë–Ω–Ω–∞—è –∑–æ–Ω–∞):**
‚Ä¢ –†–∞–∑–º–µ—â–µ–Ω–∏–µ: –≤ –≥–ª—É–±–∏–Ω–µ —Å–∫–ª–∞–¥—Å–∫–æ–π –∑–æ–Ω—ã (–¥–∞–ª–µ–µ 30 –º–µ—Ç—Ä–æ–≤ –æ—Ç –∑–æ–Ω—ã –æ—Ç–≥—Ä—É–∑–∫–∏)
‚Ä¢ –°—Ç—Ä–∞—Ç–µ–≥–∏—è: –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è —Å–∫–ª–∞–¥—Å–∫–∏—Ö –∑–∞–ø–∞—Å–æ–≤
‚Ä¢ –ó–∞–ø–∞—Å—ã: –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Å—Ç—Ä–∞—Ö–æ–≤–æ–π –∑–∞–ø–∞—Å (7-10 –¥–Ω–µ–π) –∏–ª–∏ —Ä–∞–±–æ—Ç–∞ –ø–æ–¥ –∑–∞–∫–∞–∑
‚Ä¢ –ß–∞—Å—Ç–æ—Ç–∞ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏: –µ–∂–µ–º–µ—Å—è—á–Ω–∞—è
‚Ä¢ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: —Ä–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∏—Å–∫–ª—é—á–µ–Ω–∏—è –∏–∑ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ –∞—Å—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç–∞

**‚öôÔ∏è –û–ü–ï–†–ê–¶–ò–û–ù–ù–´–ï –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:**
‚Ä¢ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –º–∞—Ä—à—Ä—É—Ç—ã –∫–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏–∏ —Å —É—á–µ—Ç–æ–º ABC-–∑–æ–Ω
‚Ä¢ –í–Ω–µ–¥—Ä–∏—Ç—å —Å–∏—Å—Ç–µ–º—É WMS –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –∞–¥—Ä–µ—Å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è
‚Ä¢ –ü—Ä–æ–≤–æ–¥–∏—Ç—å —Ä–µ–≥—É–ª—è—Ä–Ω—É—é —Ä–æ—Ç–∞—Ü–∏—é —Ç–æ–≤–∞—Ä–æ–≤ –º–µ–∂–¥—É –∑–æ–Ω–∞–º–∏ (–µ–∂–µ–∫–≤–∞—Ä—Ç–∞–ª—å–Ω–æ)
            """
            
        elif analysis_type == "XYZ":
            # –ê–Ω–∞–ª–∏–∑ XYZ
            category_col = "XYZ –ö–∞—Ç–µ–≥–æ—Ä–∏—è"
            
            # –ö–∞—Ç–µ–≥–æ—Ä–∏–∏
            cat_x = df[df[category_col] == "X"]
            cat_y = df[df[category_col] == "Y"]
            cat_z = df[df[category_col] == "Z"]
            
            # –¢–æ–≤–∞—Ä—ã —Å –Ω–∞–∏–±–æ–ª—å—à–µ–π –∏ –Ω–∞–∏–º–µ–Ω—å—à–µ–π –≤–∞—Ä–∏–∞—Ü–∏–µ–π
            most_stable = df.nsmallest(3, "–ö–æ—ç—Ñ—Ñ. –≤–∞—Ä–∏–∞—Ü–∏–∏ (%)")["–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞"].tolist()
            most_volatile = df.nlargest(3, "–ö–æ—ç—Ñ—Ñ. –≤–∞—Ä–∏–∞—Ü–∏–∏ (%)")["–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞"].tolist()
            
            message = f"""
üìä **–ê–ù–ê–õ–ò–¢–ò–ß–ï–°–ö–ò–ô –û–¢–ß–ï–¢ –ü–û XYZ-–ê–ù–ê–õ–ò–ó–£**

**üéØ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ —Å–ø—Ä–æ—Å–∞:**
‚Ä¢ –ö–∞—Ç–µ–≥–æ—Ä–∏—è X (—Å—Ç–∞–±–∏–ª—å–Ω—ã–π —Å–ø—Ä–æ—Å): {len(cat_x)} –ø–æ–∑–∏—Ü–∏–π ({len(cat_x)/len(df)*100:.1f}%)
‚Ä¢ –ö–∞—Ç–µ–≥–æ—Ä–∏—è Y (–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–π —Å–ø—Ä–æ—Å): {len(cat_y)} –ø–æ–∑–∏—Ü–∏–π ({len(cat_y)/len(df)*100:.1f}%)
‚Ä¢ –ö–∞—Ç–µ–≥–æ—Ä–∏—è Z (–Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω—ã–π —Å–ø—Ä–æ—Å): {len(cat_z)} –ø–æ–∑–∏—Ü–∏–π ({len(cat_z)/len(df)*100:.1f}%)

**üìä –ù–∞–∏–±–æ–ª–µ–µ —Å—Ç–∞–±–∏–ª—å–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ (–Ω–∏–∑–∫–∞—è –≤–∞—Ä–∏–∞—Ü–∏—è):**
{chr(10).join([f"‚Ä¢ {product}" for product in most_stable])}

**‚ö†Ô∏è –ù–∞–∏–±–æ–ª–µ–µ –≤–æ–ª–∞—Ç–∏–ª—å–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ (–≤—ã—Å–æ–∫–∞—è –≤–∞—Ä–∏–∞—Ü–∏—è):**
{chr(10).join([f"‚Ä¢ {product}" for product in most_volatile])}

**üí° –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–û –£–ü–†–ê–í–õ–ï–ù–ò–Æ –ó–ê–ü–ê–°–ê–ú–ò:**

**–ö–∞—Ç–µ–≥–æ—Ä–∏—è X (–ø—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–µ–º—ã–π —Å–ø—Ä–æ—Å, CV ‚â§ 10%):**
‚Ä¢ –°—Ç—Ä–∞—Ç–µ–≥–∏—è –∑–∞–∫—É–ø–æ–∫: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —ç–∫–æ–Ω–æ–º–∏—á–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ –∑–∞–∫–∞–∑–∞ (EOQ)
‚Ä¢ –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è: –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ç–∞–±–∏–ª—å–Ω–æ–≥–æ —Ç—Ä–µ–Ω–¥–∞
‚Ä¢ –°—Ç—Ä–∞—Ö–æ–≤–æ–π –∑–∞–ø–∞—Å: –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π (5-7 –¥–Ω–µ–π –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è)
‚Ä¢ –ß–∞—Å—Ç–æ—Ç–∞ –∑–∞–∫–∞–∑–æ–≤: —Ä–µ–≥—É–ª—è—Ä–Ω–∞—è, —Å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞–º–∏
‚Ä¢ –ú–µ—Ç–æ–¥ –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—è: –ø—Ä–æ—Å—Ç–æ–µ —Å–∫–æ–ª—å–∑—è—â–µ–µ —Å—Ä–µ–¥–Ω–µ–µ
‚Ä¢ –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è: –≤–Ω–µ–¥—Ä–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–æ–∑–∞–∫–∞–∑ –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ —Ç–æ—á–∫–∏ –ø–µ—Ä–µ–∑–∞–∫–∞–∑–∞

**–ö–∞—Ç–µ–≥–æ—Ä–∏—è Y (—É–º–µ—Ä–µ–Ω–Ω–∞—è –≤–∞—Ä–∏–∞—Ü–∏—è, 10% < CV ‚â§ 25%):**
‚Ä¢ –°—Ç—Ä–∞—Ç–µ–≥–∏—è –∑–∞–∫—É–ø–æ–∫: –∞–¥–∞–ø—Ç–∏–≤–Ω–∞—è –º–æ–¥–µ–ª—å —Å —É—á–µ—Ç–æ–º —Å–µ–∑–æ–Ω–Ω–æ—Å—Ç–∏
‚Ä¢ –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è: –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (—Ç—Ä–µ–Ω–¥ + —Å–µ–∑–æ–Ω–Ω–æ—Å—Ç—å)
‚Ä¢ –°—Ç—Ä–∞—Ö–æ–≤–æ–π –∑–∞–ø–∞—Å: —Å—Ä–µ–¥–Ω–∏–π (10-15 –¥–Ω–µ–π –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è)
‚Ä¢ –ß–∞—Å—Ç–æ—Ç–∞ –∑–∞–∫–∞–∑–æ–≤: –≥–∏–±–∫–∞—è, —Å –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–æ–π –ø–æ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–º—É —Å–ø—Ä–æ—Å—É
‚Ä¢ –ú–µ—Ç–æ–¥ –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—è: —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–µ —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ —Å —É—á–µ—Ç–æ–º —Å–µ–∑–æ–Ω–Ω–æ—Å—Ç–∏
‚Ä¢ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥: –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–π —Ñ–∞–∫—Ç/–ø–ª–∞–Ω

**–ö–∞—Ç–µ–≥–æ—Ä–∏—è Z (–≤—ã—Å–æ–∫–∞—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å, CV > 25%):**
‚Ä¢ –°—Ç—Ä–∞—Ç–µ–≥–∏—è –∑–∞–∫—É–ø–æ–∫: —Ä–∞–±–æ—Ç–∞ –ø–æ–¥ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∑–∞–∫–∞–∑ –∫–ª–∏–µ–Ω—Ç–∞ –∏–ª–∏ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –ø–∞—Ä—Ç–∏–∏
‚Ä¢ –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è: –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–µ —Ä–µ–∞–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–ø—Ä–æ—Å–∞
‚Ä¢ –°—Ç—Ä–∞—Ö–æ–≤–æ–π –∑–∞–ø–∞—Å: –ø–æ–≤—ã—à–µ–Ω–Ω—ã–π (20-30 –¥–Ω–µ–π) –ª–∏–±–æ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Å —Ä–µ–∑–µ—Ä–≤–Ω—ã–º–∏ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞–º–∏
‚Ä¢ –ß–∞—Å—Ç–æ—Ç–∞ –∑–∞–∫–∞–∑–æ–≤: –ø–æ –º–µ—Ä–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏, —Ç–µ—Å–Ω–∞—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è —Å –æ—Ç–¥–µ–ª–æ–º –ø—Ä–æ–¥–∞–∂
‚Ä¢ –ú–µ—Ç–æ–¥ –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—è: –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã (—ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–µ –æ—Ü–µ–Ω–∫–∏, –º–Ω–µ–Ω–∏–µ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤)
‚Ä¢ –û—Å–æ–±–æ–µ –≤–Ω–∏–º–∞–Ω–∏–µ: –∞–Ω–∞–ª–∏–∑ –ø—Ä–∏—á–∏–Ω –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏, –≤–æ–∑–º–æ–∂–Ω–∞—è —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–π –±–∞–∑—ã

**‚öôÔ∏è –°–¢–†–ê–¢–ï–ì–ò–ß–ï–°–ö–ò–ï –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:**
‚Ä¢ –¢–æ–≤–∞—Ä—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ X - –∫–∞–Ω–¥–∏–¥–∞—Ç—ã –¥–ª—è –∫–æ–Ω—Å–∏–≥–Ω–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Å—Ö–µ–º —Å –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞–º–∏
‚Ä¢ –¢–æ–≤–∞—Ä—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ Z - —Ä–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∑–∞–∫–ª—é—á–µ–Ω–∏—è —Ä–∞–º–æ—á–Ω—ã—Ö –¥–æ–≥–æ–≤–æ—Ä–æ–≤ —Å —Å–æ–∫—Ä–∞—â–µ–Ω–Ω—ã–º–∏ —Å—Ä–æ–∫–∞–º–∏ –ø–æ—Å—Ç–∞–≤–∫–∏
‚Ä¢ –†–µ–≥—É–ª—è—Ä–Ω–æ (–µ–∂–µ–∫–≤–∞—Ä—Ç–∞–ª—å–Ω–æ) –ø–µ—Ä–µ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å —É—á–µ—Ç–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä—ã–Ω–æ—á–Ω–æ–π –∫–æ–Ω—ä—é–Ω–∫—Ç—É—Ä—ã
‚Ä¢ –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å XYZ-–∞–Ω–∞–ª–∏–∑ —Å CRM-—Å–∏—Å—Ç–µ–º–æ–π –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—è
            """
        
        return message
    
    except Exception as e:
        return f"–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: {e}"

def create_charts(df, analysis_type="ABC"):
    """–°–æ–∑–¥–∞—Ç—å —Ä–∞–∑–ª–∏—á–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏ –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö"""
    charts = []
    
    try:
        if analysis_type == "ABC" and "ABC –ö–∞—Ç–µ–≥–æ—Ä–∏—è" in df.columns:
            # 1. –°—Ç–æ–ª–±—á–∞—Ç–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
            category_counts = df["ABC –ö–∞—Ç–µ–≥–æ—Ä–∏—è"].value_counts().reindex(["A", "B", "C"], fill_value=0).reset_index()
            category_counts.columns = ["–ö–∞—Ç–µ–≥–æ—Ä–∏—è", "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ"]
            
            fig1 = px.bar(
                category_counts,
                x="–ö–∞—Ç–µ–≥–æ—Ä–∏—è",
                y="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ",
                title="–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º ABC",
                color="–ö–∞—Ç–µ–≥–æ—Ä–∏—è",
                color_discrete_map={"A": "#2ecc71", "B": "#f39c12", "C": "#e74c3c"},
                text="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ"
            )
            fig1.update_traces(textposition='outside')
            charts.append(("bar", fig1))
            
            # 2. –ö—Ä—É–≥–æ–≤–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞
            fig2 = px.pie(
                category_counts,
                values="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ",
                names="–ö–∞—Ç–µ–≥–æ—Ä–∏—è",
                title="–î–æ–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π ABC",
                color="–ö–∞—Ç–µ–≥–æ—Ä–∏—è",
                color_discrete_map={"A": "#2ecc71", "B": "#f39c12", "C": "#e74c3c"}
            )
            charts.append(("pie", fig2))
            
            # 3. –ì—Ä–∞—Ñ–∏–∫ –ü–∞—Ä–µ—Ç–æ
            if "–í—ã—Ä—É—á–∫–∞ (–£.–ï.)" in df.columns and "–ù–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω—ã–π %" in df.columns:
                fig3 = go.Figure()
                fig3.add_trace(go.Bar(
                    x=df["–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞"],
                    y=df["–í—ã—Ä—É—á–∫–∞ (–£.–ï.)"],
                    name="–í—ã—Ä—É—á–∫–∞",
                    marker_color="#5e30dd"
                ))
                fig3.add_trace(go.Scatter(
                    x=df["–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞"],
                    y=df["–ù–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω—ã–π %"],
                    name="–ù–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–π %",
                    yaxis="y2",
                    marker_color="#e74c3c",
                    line=dict(width=3)
                ))
                fig3.update_layout(
                    title="–ì—Ä–∞—Ñ–∏–∫ –ü–∞—Ä–µ—Ç–æ (ABC –∞–Ω–∞–ª–∏–∑)",
                    xaxis_title="–¢–æ–≤–∞—Ä—ã",
                    yaxis_title="–í—ã—Ä—É—á–∫–∞ (–£.–ï.)",
                    yaxis2=dict(
                        title="–ù–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–π –ø—Ä–æ—Ü–µ–Ω—Ç",
                        overlaying="y",
                        side="right",
                        range=[0, 100]
                    ),
                    hovermode='x unified'
                )
                fig3.update_xaxes(tickangle=-45)
                charts.append(("pareto", fig3))
            
            # 4. –°—Ç–æ–ª–±—á–∞—Ç–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ —Ç–æ–ø-10 —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ –≤—ã—Ä—É—á–∫–µ
            if "–í—ã—Ä—É—á–∫–∞ (–£.–ï.)" in df.columns:
                top10 = df.head(10)
                fig4 = px.bar(
                    top10,
                    x="–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞",
                    y="–í—ã—Ä—É—á–∫–∞ (–£.–ï.)",
                    title="–¢–æ–ø-10 —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ –≤—ã—Ä—É—á–∫–µ",
                    color="ABC –ö–∞—Ç–µ–≥–æ—Ä–∏—è",
                    color_discrete_map={"A": "#2ecc71", "B": "#f39c12", "C": "#e74c3c"},
                    text="–í—ã—Ä—É—á–∫–∞ (–£.–ï.)"
                )
                fig4.update_traces(texttemplate='%{text:.0f}', textposition='outside')
                fig4.update_xaxes(tickangle=-45)
                charts.append(("top10", fig4))
        
        elif analysis_type == "XYZ" and "XYZ –ö–∞—Ç–µ–≥–æ—Ä–∏—è" in df.columns:
            # 1. –°—Ç–æ–ª–±—á–∞—Ç–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º XYZ
            category_counts = df["XYZ –ö–∞—Ç–µ–≥–æ—Ä–∏—è"].value_counts().reindex(["X", "Y", "Z"], fill_value=0).reset_index()
            category_counts.columns = ["–ö–∞—Ç–µ–≥–æ—Ä–∏—è", "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ"]
            
            fig1 = px.bar(
                category_counts,
                x="–ö–∞—Ç–µ–≥–æ—Ä–∏—è",
                y="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ",
                title="–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º XYZ",
                color="–ö–∞—Ç–µ–≥–æ—Ä–∏—è",
                color_discrete_map={"X": "#2ecc71", "Y": "#f39c12", "Z": "#e74c3c"},
                text="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ"
            )
            fig1.update_traces(textposition='outside')
            charts.append(("bar", fig1))
            
            # 2. –ö—Ä—É–≥–æ–≤–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞
            fig2 = px.pie(
                category_counts,
                values="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ",
                names="–ö–∞—Ç–µ–≥–æ—Ä–∏—è",
                title="–î–æ–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π XYZ",
                color="–ö–∞—Ç–µ–≥–æ—Ä–∏—è",
                color_discrete_map={"X": "#2ecc71", "Y": "#f39c12", "Z": "#e74c3c"}
            )
            charts.append(("pie", fig2))
            
            # 3. –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞ –≤–∞—Ä–∏–∞—Ü–∏–∏
            if "–ö–æ—ç—Ñ—Ñ. –≤–∞—Ä–∏–∞—Ü–∏–∏ (%)" in df.columns:
                fig3 = px.histogram(
                    df,
                    x="–ö–æ—ç—Ñ—Ñ. –≤–∞—Ä–∏–∞—Ü–∏–∏ (%)",
                    title="–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞ –≤–∞—Ä–∏–∞—Ü–∏–∏",
                    nbins=20,
                    color_discrete_sequence=["#9b59b6"]
                )
                fig3.add_vline(x=10, line_dash="dash", line_color="green", annotation_text="X/Y –≥—Ä–∞–Ω–∏—Ü–∞")
                fig3.add_vline(x=25, line_dash="dash", line_color="orange", annotation_text="Y/Z –≥—Ä–∞–Ω–∏—Ü–∞")
                charts.append(("histogram", fig3))
            
            # 4. –°—Ç–æ–ª–±—á–∞—Ç–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞ –≤–∞—Ä–∏–∞—Ü–∏–∏ –ø–æ —Ç–æ–≤–∞—Ä–∞–º
            if "–ö–æ—ç—Ñ—Ñ. –≤–∞—Ä–∏–∞—Ü–∏–∏ (%)" in df.columns:
                df_sorted = df.sort_values("–ö–æ—ç—Ñ—Ñ. –≤–∞—Ä–∏–∞—Ü–∏–∏ (%)", ascending=False)
                fig4 = px.bar(
                    df_sorted,
                    x="–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞",
                    y="–ö–æ—ç—Ñ—Ñ. –≤–∞—Ä–∏–∞—Ü–∏–∏ (%)",
                    title="–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –≤–∞—Ä–∏–∞—Ü–∏–∏ –ø–æ —Ç–æ–≤–∞—Ä–∞–º",
                    color="XYZ –ö–∞—Ç–µ–≥–æ—Ä–∏—è",
                    color_discrete_map={"X": "#2ecc71", "Y": "#f39c12", "Z": "#e74c3c"}
                )
                fig4.update_xaxes(tickangle=-45)
                charts.append(("cv_bar", fig4))
        
        return charts
    except Exception as e:
        st.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –≥—Ä–∞—Ñ–∏–∫–æ–≤: {e}")
        return []

# -----------------------------
# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è session_state
# -----------------------------
if "chat_history" not in st.session_state:
    st.session_state.chat_history = []
if "uploaded_df" not in st.session_state:
    st.session_state.uploaded_df = None
if "analysis_result" not in st.session_state:
    st.session_state.analysis_result = None
if "analysis_type" not in st.session_state:
    st.session_state.analysis_type = None

# -----------------------------
# Sidebar - –°–ø—Ä–∞–≤–∫–∞ –∏ –ª–æ–≥–æ—Ç–∏–ø—ã
# -----------------------------
with st.sidebar:
    st.markdown("---")
    
    # –°–ø—Ä–∞–≤–∫–∞
    st.markdown("### üìö –°–ø—Ä–∞–≤–∫–∞ –ø–æ —Ä–∞–±–æ—Ç–µ")
    st.markdown("""
    <div class="info-card">
    <h4>–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ–º–æ—â–Ω–∏–∫–∞:</h4>
    
    <b>1. –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö:</b><br>
    ‚Ä¢ –ù–∞–∂–º–∏—Ç–µ –Ω–∞ —Å–∫—Ä–µ–ø–∫—É üìé –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ Excel —Ñ–∞–π–ª–∞<br>
    ‚Ä¢ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ñ–æ—Ä–º–∞—Ç—ã .xlsx –∏ .xls<br><br>
    
    <b>2. –ö–æ–º–∞–Ω–¥—ã —á–∞—Ç–∞:</b><br>
    ‚Ä¢ "–ü—Ä–æ–≤–µ–¥–∏ ABC –∞–Ω–∞–ª–∏–∑" - –∞–Ω–∞–ª–∏–∑ –ø–æ –º–µ—Ç–æ–¥—É ABC<br>
    ‚Ä¢ "–ü—Ä–æ–≤–µ–¥–∏ XYZ –∞–Ω–∞–ª–∏–∑" - –∞–Ω–∞–ª–∏–∑ –ø–æ –º–µ—Ç–æ–¥—É XYZ<br>
    ‚Ä¢ "–ü–æ–º–æ—â—å" - —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∫–æ–º–∞–Ω–¥<br><br>
    
    <b>3. –ö–Ω–æ–ø–∫–∏ –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞:</b><br>
    ‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –∞–Ω–∞–ª–∏–∑–∞<br><br>
    
    <b>4. –≠–∫—Å–ø–æ—Ä—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:</b><br>
    ‚Ä¢ –ü–æ—Å–ª–µ –∞–Ω–∞–ª–∏–∑–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ –∫–Ω–æ–ø–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞<br>
    ‚Ä¢ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ Excel —Ñ–æ—Ä–º–∞—Ç–µ<br><br>
    
    <b>–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–∞:</b><br>
    –í–∞—à Excel —Ñ–∞–π–ª –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Å—Ç–æ–ª–±—Ü—ã "–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞", "–í—ã—Ä—É—á–∫–∞ (–£.–ï.)" –∏ –¥–∞–Ω–Ω—ã–µ –ø–æ –∫–≤–∞—Ä—Ç–∞–ª–∞–º.
    </div>
    """, unsafe_allow_html=True)
    
    st.markdown("---")
    
    st.markdown("""
    <div class="info-card">
    <h4>‚ÑπÔ∏è –û –º–µ—Ç–æ–¥–∞—Ö –∞–Ω–∞–ª–∏–∑–∞</h4>
    
    <b>ABC –∞–Ω–∞–ª–∏–∑:</b><br>
    –ú–µ—Ç–æ–¥ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ —Å—Ç–µ–ø–µ–Ω–∏ –≤–ª–∏—è–Ω–∏—è –Ω–∞ –æ–±—â—É—é –≤—ã—Ä—É—á–∫—É:<br>
    ‚Ä¢ A - 70% –≤—ã—Ä—É—á–∫–∏ (–Ω–∞–∏–±–æ–ª–µ–µ –≤–∞–∂–Ω—ã–µ)<br>
    ‚Ä¢ B - 20% –≤—ã—Ä—É—á–∫–∏ (—Å—Ä–µ–¥–Ω–µ–π –≤–∞–∂–Ω–æ—Å—Ç–∏)<br>
    ‚Ä¢ C - 10% –≤—ã—Ä—É—á–∫–∏ (–Ω–∞–∏–º–µ–Ω–µ–µ –≤–∞–∂–Ω—ã–µ)<br><br>
    
    <b>XYZ –∞–Ω–∞–ª–∏–∑:</b><br>
    –ú–µ—Ç–æ–¥ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø–æ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ –ø—Ä–æ–¥–∞–∂:<br>
    ‚Ä¢ X - CV ‚â§ 10% (—Å—Ç–∞–±–∏–ª—å–Ω—ã–µ)<br>
    ‚Ä¢ Y - 10% < CV ‚â§ 25% (–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ)<br>
    ‚Ä¢ Z - CV > 25% (–Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω—ã–µ)<br>
    </div>
    """, unsafe_allow_html=True)

# -----------------------------
# –û—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å
# -----------------------------

# –ó–∞–≥–æ–ª–æ–≤–æ–∫
st.markdown("<h1 style='text-align: center;'>üìä –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–º–æ—â–Ω–∏–∫ ABC/XYZ</h1>", unsafe_allow_html=True)
st.markdown("<p style='text-align: center; color: white; font-size: 1.2rem;'>–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö —Å –ø–æ–º–æ—â—å—é –ò–ò</p>", unsafe_allow_html=True)

# –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –∫–æ–ª–æ–Ω–∫–∏
col1, col2 = st.columns([2, 1])

with col1:
    # –û–±–ª–∞—Å—Ç—å –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    st.markdown("<div class='info-card'>", unsafe_allow_html=True)
    
    # –ó–∞–≥—Ä—É–∑—á–∏–∫ —Ñ–∞–π–ª–∞ (—Å–∫—Ä–µ–ø–∫–∞)
    uploaded_file = st.file_uploader(
        "üìé –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ Excel —Ñ–∞–π–ª –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞",
        type=["xlsx", "xls"],
        help="–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª —Å –¥–∞–Ω–Ω—ã–º–∏ –¥–ª—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è ABC/XYZ –∞–Ω–∞–ª–∏–∑–∞"
    )
    
    if uploaded_file is not None:
        try:
            # –ß—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–∞
            df = pd.read_excel(uploaded_file, sheet_name=0, header=None)
            st.session_state.uploaded_df = df
            st.success(f"‚úÖ –§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω! –ù–∞–π–¥–µ–Ω–æ {df.shape[0]} —Å—Ç—Ä–æ–∫ –∏ {df.shape[1]} —Å—Ç–æ–ª–±—Ü–æ–≤.")
            
            # –ü—Ä–µ–≤—å—é –¥–∞–Ω–Ω—ã—Ö
            with st.expander("üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö", expanded=False):
                st.dataframe(df.head(15), use_container_width=True)
                st.caption(f"–ü–æ–∫–∞–∑–∞–Ω—ã –ø–µ—Ä–≤—ã–µ 15 —Å—Ç—Ä–æ–∫ –∏–∑ {len(df)}")
        
        except Exception as e:
            st.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞: {e}")
    
    st.markdown("</div>", unsafe_allow_html=True)
    
    # –ö–Ω–æ–ø–∫–∏ –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
    st.markdown("<br>", unsafe_allow_html=True)
    btn_col1, btn_col2, btn_col3 = st.columns(3)
    
    with btn_col1:
        if st.button("üîç –ü—Ä–æ–≤–µ—Å—Ç–∏ ABC –∞–Ω–∞–ª–∏–∑", use_container_width=True):
            if st.session_state.uploaded_df is not None:
                st.session_state.chat_history.append({
                    "speaker": "user",
                    "text": "–ü—Ä–æ–≤–µ–¥–∏ ABC –∞–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö"
                })
                
                # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –∞–Ω–∞–ª–∏–∑–∞
                status_placeholder = st.empty()
                status_placeholder.info("üîÑ –ü—Ä–æ–≤–æ–∂—É ABC –∞–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö... –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ –æ–∫–æ–ª–æ 5 —Å–µ–∫—É–Ω–¥...")
                
                with st.spinner("–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –¥–∞–Ω–Ω—ã–µ..."):
                    time.sleep(5)  # –ó–∞–¥–µ—Ä–∂–∫–∞ 5 —Å–µ–∫—É–Ω–¥
                    df_result, error = perform_abc_analysis(st.session_state.uploaded_df)
                    if error:
                        status_placeholder.empty()
                        st.session_state.chat_history.append({
                            "speaker": "bot",
                            "text": f"‚ùå –û—à–∏–±–∫–∞: {error}"
                        })
                    else:
                        st.session_state.analysis_result = df_result
                        st.session_state.analysis_type = "ABC"
                        
                        # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
                        analytics = generate_analytics_message(df_result, "ABC")
                        
                        status_placeholder.empty()
                        st.session_state.chat_history.append({
                            "speaker": "bot",
                            "text": "‚úÖ ABC –∞–Ω–∞–ª–∏–∑ —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω! –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—Ç–æ–±—Ä–∞–∂–µ–Ω—ã –Ω–∏–∂–µ."
                        })
                        st.session_state.chat_history.append({
                            "speaker": "bot",
                            "text": analytics
                        })
                        st.rerun()
            else:
                st.warning("‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª!")
    
    with btn_col2:
        if st.button("üìä –ü—Ä–æ–≤–µ—Å—Ç–∏ XYZ –∞–Ω–∞–ª–∏–∑", use_container_width=True):
            if st.session_state.uploaded_df is not None:
                st.session_state.chat_history.append({
                    "speaker": "user",
                    "text": "–ü—Ä–æ–≤–µ–¥–∏ XYZ –∞–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö"
                })
                
                # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –∞–Ω–∞–ª–∏–∑–∞
                status_placeholder = st.empty()
                status_placeholder.info("üîÑ –ü—Ä–æ–≤–æ–∂—É XYZ –∞–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö... –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ –æ–∫–æ–ª–æ 5 —Å–µ–∫—É–Ω–¥...")
                
                with st.spinner("–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –¥–∞–Ω–Ω—ã–µ..."):
                    time.sleep(5)  # –ó–∞–¥–µ—Ä–∂–∫–∞ 5 —Å–µ–∫—É–Ω–¥
                    df_result, error = perform_xyz_analysis(st.session_state.uploaded_df)
                    if error:
                        status_placeholder.empty()
                        st.session_state.chat_history.append({
                            "speaker": "bot",
                            "text": f"‚ùå –û—à–∏–±–∫–∞: {error}"
                        })
                    else:
                        st.session_state.analysis_result = df_result
                        st.session_state.analysis_type = "XYZ"
                        
                        # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
                        analytics = generate_analytics_message(df_result, "XYZ")
                        
                        status_placeholder.empty()
                        st.session_state.chat_history.append({
                            "speaker": "bot",
                            "text": "‚úÖ XYZ –∞–Ω–∞–ª–∏–∑ —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω! –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—Ç–æ–±—Ä–∞–∂–µ–Ω—ã –Ω–∏–∂–µ."
                        })
                        st.session_state.chat_history.append({
                            "speaker": "bot",
                            "text": analytics
                        })
                        st.rerun()
            else:
                st.warning("‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª!")
    
    with btn_col3:
        if st.button("üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã", use_container_width=True):
            st.session_state.analysis_result = None
            st.session_state.analysis_type = None
            st.session_state.chat_history.append({
                "speaker": "system",
                "text": "üóëÔ∏è –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ –æ—á–∏—â–µ–Ω—ã"
            })
            st.rerun()
    
    # –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∞–Ω–∞–ª–∏–∑–∞
    if st.session_state.analysis_result is not None:
        st.markdown("<br>", unsafe_allow_html=True)
        st.markdown("<div class='info-card'>", unsafe_allow_html=True)
        st.markdown(f"### üìã –†–µ–∑—É–ª—å—Ç–∞—Ç—ã {st.session_state.analysis_type} –∞–Ω–∞–ª–∏–∑–∞")
        
        # –¢–∞–±–ª–∏—Ü–∞ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
        st.dataframe(st.session_state.analysis_result, use_container_width=True, height=400)
        
        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        if st.session_state.analysis_type == "ABC" and "ABC –ö–∞—Ç–µ–≥–æ—Ä–∏—è" in st.session_state.analysis_result.columns:
            st.markdown("#### üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º")
            stat_cols = st.columns(3)
            for idx, cat in enumerate(["A", "B", "C"]):
                count = len(st.session_state.analysis_result[st.session_state.analysis_result["ABC –ö–∞—Ç–µ–≥–æ—Ä–∏—è"] == cat])
                total = len(st.session_state.analysis_result)
                percentage = (count / total * 100) if total > 0 else 0
                with stat_cols[idx]:
                    st.metric(f"–ö–∞—Ç–µ–≥–æ—Ä–∏—è {cat}", f"{count} —Ç–æ–≤–∞—Ä–æ–≤", f"{percentage:.1f}%")
        
        elif st.session_state.analysis_type == "XYZ" and "XYZ –ö–∞—Ç–µ–≥–æ—Ä–∏—è" in st.session_state.analysis_result.columns:
            st.markdown("#### üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º")
            stat_cols = st.columns(3)
            for idx, cat in enumerate(["X", "Y", "Z"]):
                count = len(st.session_state.analysis_result[st.session_state.analysis_result["XYZ –ö–∞—Ç–µ–≥–æ—Ä–∏—è"] == cat])
                total = len(st.session_state.analysis_result)
                percentage = (count / total * 100) if total > 0 else 0
                with stat_cols[idx]:
                    st.metric(f"–ö–∞—Ç–µ–≥–æ—Ä–∏—è {cat}", f"{count} —Ç–æ–≤–∞—Ä–æ–≤", f"{percentage:.1f}%")
        
        # –ì—Ä–∞—Ñ–∏–∫–∏
        st.markdown("#### üìà –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤")
        charts = create_charts(st.session_state.analysis_result, st.session_state.analysis_type)
        
        if charts:
            for chart_type, fig in charts:
                st.plotly_chart(fig, use_container_width=True)
        
        # –ö–Ω–æ–ø–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞
        if st.button("üíæ –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ Excel"):
            output = BytesIO()
            with pd.ExcelWriter(output, engine='openpyxl') as writer:
                st.session_state.analysis_result.to_excel(writer, sheet_name='–†–µ–∑—É–ª—å—Ç–∞—Ç—ã', index=False)
            output.seek(0)
            
            st.download_button(
                label="‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏",
                data=output,
                file_name=f"{st.session_state.analysis_type}_analysis_results.xlsx",
                mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
                use_container_width=True
            )
        
        st.markdown("</div>", unsafe_allow_html=True)

with col2:
    # –ß–∞—Ç-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
    st.markdown("<div class='info-card'>", unsafe_allow_html=True)
    st.markdown("### üí¨ –ß–∞—Ç —Å –ø–æ–º–æ—â–Ω–∏–∫–æ–º")
    
    # –ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞
    chat_container = st.container()
    with chat_container:
        for msg in st.session_state.chat_history[-10:]:  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å–æ–æ–±—â–µ–Ω–∏–π
            if msg["speaker"] == "user":
                st.markdown(f"""
                <div class="chat-message user-message">
                    <b>üë§ –í—ã:</b><br>{msg["text"]}
</div>
                """, unsafe_allow_html=True)
            elif msg["speaker"] == "bot":
                st.markdown(f"""
                <div class="chat-message bot-message">
                    <b>ü§ñ –ü–æ–º–æ—â–Ω–∏–∫:</b><br>{msg["text"]}
</div>
                """, unsafe_allow_html=True)
            elif msg["speaker"] == "system":
                st.markdown(f"""
                <div class="chat-message system-message">
                    <b>‚öôÔ∏è –°–∏—Å—Ç–µ–º–∞:</b><br>{msg["text"]}
</div>
                """, unsafe_allow_html=True)
    
    # –§–æ—Ä–º–∞ –≤–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
    with st.form(key="chat_form", clear_on_submit=True):
        user_input = st.text_area(
            "–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:",
            height=100,
            placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ü—Ä–æ–≤–µ–¥–∏ ABC –∞–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö...",
            label_visibility="collapsed"
        )
        submit_col1, submit_col2 = st.columns([3, 1])
        with submit_col1:
            submitted = st.form_submit_button("üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å", use_container_width=True)
        with submit_col2:
            clear_chat = st.form_submit_button("üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å", use_container_width=True)
    
    if clear_chat:
        st.session_state.chat_history = []
        st.rerun()
    
    if submitted and user_input:
        # –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        st.session_state.chat_history.append({
            "speaker": "user",
            "text": user_input.strip()
        })
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º "–¥—É–º–∞—é—â–µ–µ" —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        with st.spinner("–î—É–º–∞—é..."):
            time.sleep(random.uniform(1, 2))
            
            # –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç
            response = get_response(user_input)
            
            # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö –∫–æ–º–∞–Ω–¥
            if response == "ABC_ANALYSIS":
                if st.session_state.uploaded_df is not None:
                    # –ó–∞–¥–µ—Ä–∂–∫–∞ 5 —Å–µ–∫—É–Ω–¥ –ø–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º –∞–Ω–∞–ª–∏–∑–∞
                    st.session_state.chat_history.append({
                        "speaker": "bot",
                        "text": "üîÑ –ù–∞—á–∏–Ω–∞—é ABC –∞–Ω–∞–ª–∏–∑... –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ –æ–∫–æ–ª–æ 5 —Å–µ–∫—É–Ω–¥..."
                    })
                    st.rerun()
                    time.sleep(5)
                    
                    df_result, error = perform_abc_analysis(st.session_state.uploaded_df)
                    if error:
                        response = f"‚ùå {error}"
                    else:
                        st.session_state.analysis_result = df_result
                        st.session_state.analysis_type = "ABC"
                        analytics = generate_analytics_message(df_result, "ABC")
                        response = "‚úÖ ABC –∞–Ω–∞–ª–∏–∑ —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω! –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—Ç–æ–±—Ä–∞–∂–µ–Ω—ã —Å–ª–µ–≤–∞ –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏."
                        st.session_state.chat_history.append({
                            "speaker": "bot",
                            "text": response
                        })
                        st.session_state.chat_history.append({
                            "speaker": "bot",
                            "text": analytics
                        })
                        st.rerun()
                else:
                    response = "‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ Excel —Ñ–∞–π–ª —Å –¥–∞–Ω–Ω—ã–º–∏, –∏—Å–ø–æ–ª—å–∑—É—è –∫–Ω–æ–ø–∫—É —Å —Å–∫—Ä–µ–ø–∫–æ–π üìé –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏."
            
            elif response == "XYZ_ANALYSIS":
                if st.session_state.uploaded_df is not None:
                    # –ó–∞–¥–µ—Ä–∂–∫–∞ 5 —Å–µ–∫—É–Ω–¥ –ø–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º –∞–Ω–∞–ª–∏–∑–∞
                    st.session_state.chat_history.append({
                        "speaker": "bot",
                        "text": "üîÑ –ù–∞—á–∏–Ω–∞—é XYZ –∞–Ω–∞–ª–∏–∑... –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ –æ–∫–æ–ª–æ 5 —Å–µ–∫—É–Ω–¥..."
                    })
                    st.rerun()
                    time.sleep(5)
                    
                    df_result, error = perform_xyz_analysis(st.session_state.uploaded_df)
                    if error:
                        response = f"‚ùå {error}"
                    else:
                        st.session_state.analysis_result = df_result
                        st.session_state.analysis_type = "XYZ"
                        analytics = generate_analytics_message(df_result, "XYZ")
                        response = "‚úÖ XYZ –∞–Ω–∞–ª–∏–∑ —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω! –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—Ç–æ–±—Ä–∞–∂–µ–Ω—ã —Å–ª–µ–≤–∞ –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏."
                        st.session_state.chat_history.append({
                            "speaker": "bot",
                            "text": response
                        })
                        st.session_state.chat_history.append({
                            "speaker": "bot",
                            "text": analytics
                        })
                        st.rerun()
                else:
                    response = "‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ Excel —Ñ–∞–π–ª —Å –¥–∞–Ω–Ω—ã–º–∏, –∏—Å–ø–æ–ª—å–∑—É—è –∫–Ω–æ–ø–∫—É —Å —Å–∫—Ä–µ–ø–∫–æ–π üìé –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏."
            
            elif response == "SHOW_DATA":
                if st.session_state.uploaded_df is not None:
                    response = f"üìä –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã. –í—Å–µ–≥–æ —Å—Ç—Ä–æ–∫: {len(st.session_state.uploaded_df)}, —Å—Ç–æ–ª–±—Ü–æ–≤: {len(st.session_state.uploaded_df.columns)}."
                else:
                    response = "‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ Excel —Ñ–∞–π–ª —Å –¥–∞–Ω–Ω—ã–º–∏."
            
            # –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –±–æ—Ç–∞
            st.session_state.chat_history.append({
                "speaker": "bot",
                "text": response
            })
        
        st.rerun()
    
    st.markdown("</div>", unsafe_allow_html=True)

# –§—É—Ç–µ—Ä
st.markdown("---")
st.markdown("""
<p style='text-align: center; color: white !important; opacity: 0.8; font-size: 0.9rem;'>
    ¬© 2025 –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–º–æ—â–Ω–∏–∫ ABC/XYZ | –ü—Ä–æ–µ–∫—Ç –ù–æ–≥–∏–Ω—Å–∫–æ–≥–æ –∫–æ–ª–ª–µ–¥–∂–∞ 
</p>
""", unsafe_allow_html=True)